<div class="modal-backdrop" (click)="close.emit()" (keydown)="onKeyDown($event)">
  @if (copyMessage()) {
    <div class="copy-toast" role="status">{{ copyMessage() }}</div>
  }

  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal__header">
      <h2 class="modal__title">{{ isEditMode() ? 'Edit Password' : 'Create Password' }}</h2>
      <button class="modal__close" (click)="close.emit()" aria-label="Close">
        <i class="lucide icon-x" aria-hidden="true"></i>
      </button>
    </div>

    <form [formGroup]="form" (ngSubmit)="onSubmit()" class="modal__content">
      <div class="form-field">
        <label for="title" class="form-label"> Title <span class="required">*</span> </label>
        <input
          id="title"
          type="text"
          formControlName="title"
          placeholder="Ex: Gmail, GitHub, Netflix..."
          class="form-input"
          [class.error]="title?.invalid && title?.touched"
        />
        @if (title?.invalid && title?.touched) {
          <div class="error-message">
            @if (title?.errors?.['required']) {
              <span>Title is required</span>
            }
            @if (title?.errors?.['minlength']) {
              <span>Title must be at least 3 characters</span>
            }
          </div>
        }
      </div>

      <div class="form-field">
        <label for="username" class="form-label">
          Username/Email <span class="required">*</span>
        </label>
        <div class="input-with-icon">
          <input
            id="username"
            type="text"
            formControlName="username"
            placeholder="Enter username or email"
            class="form-input"
            [class.error]="username?.invalid && username?.touched"
          />
          @if (form.get('username')?.value) {
            <button
              type="button"
              class="icon-btn"
              (click)="copyToClipboard(form.get('username')?.value, 'Username')"
              title="Copy username"
            >
              <i class="lucide icon-copy" aria-hidden="true"></i>
            </button>
          }
        </div>
        @if (username?.invalid && username?.touched) {
          <div class="error-message">
            @if (username?.errors?.['required']) {
              <span>Username is required</span>
            }
            @if (username?.errors?.['minlength']) {
              <span>Username must be at least 3 characters</span>
            }
          </div>
        }
      </div>

      <div class="form-field">
        <label for="password" class="form-label"> Password <span class="required">*</span> </label>
        <div class="input-with-icon">
          <input
            id="password"
            [type]="showPassword() ? 'text' : 'password'"
            formControlName="password"
            placeholder="Enter password"
            class="form-input password-input"
            [class.error]="password?.invalid && password?.touched"
          />
          <div class="icon-group">
            <button
              type="button"
              class="icon-btn"
              (click)="togglePasswordVisibility()"
              [title]="showPassword() ? 'Hide password' : 'Show password'"
            >
              <i
                class="lucide"
                [ngClass]="showPassword() ? 'icon-eye-off' : 'icon-eye'"
                aria-hidden="true"
              ></i>
            </button>
            <button
              type="button"
              class="icon-btn"
              (click)="generatePassword()"
              title="Generate strong password"
            >
              <i class="lucide icon-wand-sparkles" aria-hidden="true"></i>
            </button>
            @if (form.get('password')?.value) {
              <button
                type="button"
                class="icon-btn"
                (click)="copyToClipboard(form.get('password')?.value, 'Password')"
                title="Copy password"
              >
                <i class="lucide icon-copy" aria-hidden="true"></i>
              </button>
            }
          </div>
        </div>
        @if (password?.invalid && password?.touched) {
          <div class="error-message">
            @if (password?.errors?.['required']) {
              <span>Password is required</span>
            }
            @if (password?.errors?.['minlength']) {
              <span>Password must be at least 6 characters</span>
            }
          </div>
        }
        <div class="password-strength">
          <div class="strength-bar">
            <div
              class="strength-fill"
              [ngClass]="{
                weak: (form.get('password')?.value?.length || 0) < 8,
                medium:
                  (form.get('password')?.value?.length || 0) >= 8 &&
                  (form.get('password')?.value?.length || 0) < 12,
                strong: (form.get('password')?.value?.length || 0) >= 12,
              }"
            ></div>
          </div>
        </div>
      </div>

      <div class="modal__footer">
        @if (isEditMode()) {
          <button
            type="button"
            class="modal__btn modal__btn--danger"
            (click)="onDelete()"
            [disabled]="isSaving()"
          >
            <i class="lucide icon-trash-2" aria-hidden="true"></i>
            Delete
          </button>
        }

        <div style="flex: 1"></div>

        <button
          type="button"
          class="modal__btn modal__btn--secondary"
          (click)="close.emit()"
          [disabled]="isSaving()"
        >
          Cancel
        </button>

        <button
          type="submit"
          class="modal__btn modal__btn--primary"
          [disabled]="form.invalid || isSaving()"
        >
          @if (isSaving()) {
            <i class="lucide icon-loader-circle animate-spin" aria-hidden="true"></i>
            <span>Saving...</span>
          } @else {
            <i class="lucide icon-save" aria-hidden="true"></i>
            <span>{{ isEditMode() ? 'Save' : 'Create' }}</span>
          }
        </button>
      </div>
    </form>
  </div>

  @if (masterPasswordService.isModalOpen()) {
    <app-master-password-modal [purpose]="masterPasswordService.modalPurpose()" />
  }
</div>
